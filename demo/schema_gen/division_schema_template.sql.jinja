-- Division schema template
-- Division: {{ division_code }}
-- Archetype: {{ archetype }}
-- Dirty naming: {{ dirty_naming }}

CREATE SCHEMA IF NOT EXISTS {{ division_schema }};
SET search_path TO {{ division_schema }};

-- Base ERP schema (85 tables)
\i {{ base_schema_path }}

-- ============================================
-- Lookup codes (coded value decoding)
-- ============================================

CREATE TABLE IF NOT EXISTS lookup_codes (
    lookup_id SERIAL PRIMARY KEY,
    domain VARCHAR(50) NOT NULL,
    code VARCHAR(20) NOT NULL,
    meaning VARCHAR(100) NOT NULL,
    display_order INT,
    is_active BOOLEAN DEFAULT TRUE,
    UNIQUE(domain, code)
);

-- ============================================
-- Shared deepening tables (all divisions)
-- ============================================

-- HR: onboarding tasks
CREATE TABLE IF NOT EXISTS hr_onboarding_tasks (
    task_id SERIAL PRIMARY KEY,
    employee_id INT REFERENCES employees(employee_id),
    task_name TEXT NOT NULL,
    due_date DATE,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_hr_onboarding_tasks_employee ON hr_onboarding_tasks(employee_id);

-- HR: payroll (legacy naming drift)
CREATE TABLE IF NOT EXISTS payroll_run_hdr (
    run_id SERIAL PRIMARY KEY,
    pay_period_start DATE NOT NULL,
    pay_period_end DATE NOT NULL,
    run_date DATE NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);

CREATE TABLE IF NOT EXISTS payroll_run_line (
    line_id SERIAL PRIMARY KEY,
    run_id INT REFERENCES payroll_run_hdr(run_id),
    employee_id INT REFERENCES employees(employee_id),
    gross_pay NUMERIC(12,2) NOT NULL,
    tax_withheld NUMERIC(12,2) NOT NULL,
    net_pay NUMERIC(12,2) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_payroll_run_line_run ON payroll_run_line(run_id);
CREATE INDEX IF NOT EXISTS idx_payroll_run_line_employee ON payroll_run_line(employee_id);

-- HR: benefit elections
CREATE TABLE IF NOT EXISTS hr_benefit_elections (
    election_id SERIAL PRIMARY KEY,
    employee_id INT REFERENCES employees(employee_id),
    benefit_type_id INT REFERENCES benefit_types(benefit_type_id),
    coverage_level VARCHAR(50),
    election_date DATE NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_hr_benefit_elections_employee ON hr_benefit_elections(employee_id);

-- HR: time clock entries
CREATE TABLE IF NOT EXISTS hr_time_clock_entries (
    entry_id SERIAL PRIMARY KEY,
    employee_id INT REFERENCES employees(employee_id),
    clock_in TIMESTAMPTZ NOT NULL,
    clock_out TIMESTAMPTZ,
    work_date DATE NOT NULL,
    source VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_hr_time_clock_entries_employee ON hr_time_clock_entries(employee_id);

-- Finance: AP invoices
CREATE TABLE IF NOT EXISTS finance_ap_invoices (
    ap_invoice_id SERIAL PRIMARY KEY,
    vendor_id INT REFERENCES vendors(vendor_id),
    invoice_number TEXT NOT NULL,
    invoice_date DATE NOT NULL,
    due_date DATE,
    amount NUMERIC(12,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_finance_ap_invoices_vendor ON finance_ap_invoices(vendor_id);

-- Finance: AR invoices
CREATE TABLE IF NOT EXISTS finance_ar_invoices (
    ar_invoice_id SERIAL PRIMARY KEY,
    customer_id INT REFERENCES customers(customer_id),
    invoice_number TEXT NOT NULL,
    invoice_date DATE NOT NULL,
    due_date DATE,
    amount NUMERIC(12,2) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_finance_ar_invoices_customer ON finance_ar_invoices(customer_id);

-- Finance: AR payments
CREATE TABLE IF NOT EXISTS finance_ar_payments (
    payment_id SERIAL PRIMARY KEY,
    ar_invoice_id INT REFERENCES finance_ar_invoices(ar_invoice_id),
    payment_date DATE NOT NULL,
    amount NUMERIC(12,2) NOT NULL,
    payment_method VARCHAR(30),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_finance_ar_payments_invoice ON finance_ar_payments(ar_invoice_id);

-- Procurement: RFQs
CREATE TABLE IF NOT EXISTS procurement_rfqs (
    rfq_id SERIAL PRIMARY KEY,
    requested_by INT REFERENCES employees(employee_id),
    rfq_date DATE NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);

-- Procurement: RFQ responses
CREATE TABLE IF NOT EXISTS procurement_rfq_responses (
    response_id SERIAL PRIMARY KEY,
    rfq_id INT REFERENCES procurement_rfqs(rfq_id),
    vendor_id INT REFERENCES vendors(vendor_id),
    response_date DATE NOT NULL,
    quoted_amount NUMERIC(12,2),
    status VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_procurement_rfq_responses_rfq ON procurement_rfq_responses(rfq_id);

-- Procurement: PO approvals
CREATE TABLE IF NOT EXISTS procurement_po_approvals (
    approval_id SERIAL PRIMARY KEY,
    po_id INT REFERENCES purchase_orders(po_id),
    approved_by INT REFERENCES employees(employee_id),
    approval_date DATE NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_procurement_po_approvals_po ON procurement_po_approvals(po_id);

-- ============================================
-- Generic approval workflow (shared across modules)
-- ============================================
CREATE TABLE IF NOT EXISTS wf_approval_request (
    request_id SERIAL PRIMARY KEY,
    entity_type VARCHAR(50) NOT NULL,
    entity_id INT NOT NULL,
    requested_by INT REFERENCES employees(employee_id),
    status VARCHAR(20) NOT NULL,
    requested_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_wf_approval_request_entity ON wf_approval_request(entity_type, entity_id);

CREATE TABLE IF NOT EXISTS wf_approval_step (
    step_id SERIAL PRIMARY KEY,
    request_id INT REFERENCES wf_approval_request(request_id),
    step_number INT NOT NULL,
    approver_id INT REFERENCES employees(employee_id),
    status VARCHAR(20) NOT NULL,
    due_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_wf_approval_step_request ON wf_approval_step(request_id);

CREATE TABLE IF NOT EXISTS wf_approval_action (
    action_id SERIAL PRIMARY KEY,
    step_id INT REFERENCES wf_approval_step(step_id),
    actor_id INT REFERENCES employees(employee_id),
    action VARCHAR(20) NOT NULL,
    action_ts TIMESTAMPTZ NOT NULL,
    comments TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_wf_approval_action_step ON wf_approval_action(step_id);

-- Link approvals to POs and vendor invoices via approval_request_id
ALTER TABLE purchase_orders ADD COLUMN IF NOT EXISTS approval_request_id INT;
ALTER TABLE purchase_orders ADD CONSTRAINT IF NOT EXISTS fk_po_approval_request
    FOREIGN KEY (approval_request_id) REFERENCES wf_approval_request(request_id);
CREATE INDEX IF NOT EXISTS idx_purchase_orders_approval_request ON purchase_orders(approval_request_id);

ALTER TABLE vendor_invoices ADD COLUMN IF NOT EXISTS approval_request_id INT;
ALTER TABLE vendor_invoices ADD CONSTRAINT IF NOT EXISTS fk_vendor_invoice_approval_request
    FOREIGN KEY (approval_request_id) REFERENCES wf_approval_request(request_id);
CREATE INDEX IF NOT EXISTS idx_vendor_invoices_approval_request ON vendor_invoices(approval_request_id);

-- Inventory: lots/serials
CREATE TABLE IF NOT EXISTS inventory_lots (
    lot_id SERIAL PRIMARY KEY,
    product_id INT REFERENCES products(product_id),
    warehouse_id INT REFERENCES warehouses(warehouse_id),
    lot_number TEXT NOT NULL,
    received_date DATE NOT NULL,
    expiration_date DATE,
    quantity NUMERIC(12,2) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_inventory_lots_product ON inventory_lots(product_id);

-- Inventory: QC inspections
CREATE TABLE IF NOT EXISTS inventory_qc_inspections (
    qc_id SERIAL PRIMARY KEY,
    lot_id INT REFERENCES inventory_lots(lot_id),
    inspector_id INT REFERENCES employees(employee_id),
    inspection_date DATE NOT NULL,
    result VARCHAR(20) NOT NULL,
    defect_count INT DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_inventory_qc_inspections_lot ON inventory_qc_inspections(lot_id);

-- Finance: GL batch + posting periods
CREATE TABLE IF NOT EXISTS finance_gl_batch (
    batch_id SERIAL PRIMARY KEY,
    batch_number TEXT NOT NULL,
    batch_date DATE NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_by INT REFERENCES employees(employee_id),
    posted_by INT REFERENCES employees(employee_id),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by_user INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_finance_gl_batch_date ON finance_gl_batch(batch_date);

CREATE TABLE IF NOT EXISTS finance_posting_period (
    posting_period_id SERIAL PRIMARY KEY,
    fiscal_period_id INT REFERENCES fiscal_periods(period_id),
    period_name TEXT NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_finance_posting_period_dates ON finance_posting_period(start_date, end_date);

CREATE TABLE IF NOT EXISTS finance_period_status (
    period_status_id SERIAL PRIMARY KEY,
    posting_period_id INT REFERENCES finance_posting_period(posting_period_id),
    module VARCHAR(30) NOT NULL,
    status VARCHAR(20) NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    updated_by INT
);
CREATE INDEX IF NOT EXISTS idx_finance_period_status_period ON finance_period_status(posting_period_id);

-- Link approvals to GL batches and journal entries
ALTER TABLE finance_gl_batch ADD COLUMN IF NOT EXISTS approval_request_id INT;
ALTER TABLE finance_gl_batch ADD CONSTRAINT IF NOT EXISTS fk_gl_batch_approval_request
    FOREIGN KEY (approval_request_id) REFERENCES wf_approval_request(request_id);
CREATE INDEX IF NOT EXISTS idx_finance_gl_batch_approval_request ON finance_gl_batch(approval_request_id);

ALTER TABLE journal_entries ADD COLUMN IF NOT EXISTS batch_id INT;
ALTER TABLE journal_entries ADD CONSTRAINT IF NOT EXISTS fk_journal_entries_batch
    FOREIGN KEY (batch_id) REFERENCES finance_gl_batch(batch_id);
CREATE INDEX IF NOT EXISTS idx_journal_entries_batch ON journal_entries(batch_id);

-- Support: tickets (legacy naming drift)
CREATE TABLE IF NOT EXISTS cust_srv_case (
    case_id SERIAL PRIMARY KEY,
    cust_id INT REFERENCES customers(customer_id),
    opened_by INT REFERENCES employees(employee_id),
    opened_at TIMESTAMPTZ NOT NULL,
    status VARCHAR(20) NOT NULL,
    priority VARCHAR(20),
    subject TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_cust_srv_case_cust ON cust_srv_case(cust_id);

CREATE TABLE IF NOT EXISTS support_ticket_comments (
    comment_id SERIAL PRIMARY KEY,
    case_id INT REFERENCES cust_srv_case(case_id),
    commenter_id INT REFERENCES employees(employee_id),
    comment_ts TIMESTAMPTZ NOT NULL,
    comment_text TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by INT,
    updated_at TIMESTAMPTZ,
    updated_by INT,
    is_deleted BOOLEAN DEFAULT FALSE,
    source_system TEXT,
    effective_start DATE DEFAULT CURRENT_DATE,
    effective_end DATE
);
CREATE INDEX IF NOT EXISTS idx_support_ticket_comments_case ON support_ticket_comments(case_id);

-- ============================================
-- Ambiguous join tables (all divisions)
-- ============================================

-- Alternative path: employee → cost_center → department (vs direct employees.department_id)
CREATE TABLE IF NOT EXISTS cost_center_assignments (
    assignment_id SERIAL PRIMARY KEY,
    employee_id INT REFERENCES employees(employee_id),
    cost_center_id INT REFERENCES cost_centers(cost_center_id),
    department_id INT REFERENCES departments(department_id),
    allocation_pct NUMERIC(5,2) DEFAULT 100.00,
    effective_start DATE NOT NULL,
    effective_end DATE,
    is_primary BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_cc_assign_employee ON cost_center_assignments(employee_id);
CREATE INDEX IF NOT EXISTS idx_cc_assign_cc ON cost_center_assignments(cost_center_id);

-- Alternative path: customer → ship_to_site → address (vs direct customer billing address)
CREATE TABLE IF NOT EXISTS customer_ship_to_sites (
    site_id SERIAL PRIMARY KEY,
    customer_id INT REFERENCES customers(customer_id),
    site_name VARCHAR(100) NOT NULL,
    address_id INT REFERENCES addresses(address_id),
    is_default BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_ship_to_customer ON customer_ship_to_sites(customer_id);

-- Add ship_to_site_id to sales_orders as alternate join path
ALTER TABLE sales_orders ADD COLUMN IF NOT EXISTS ship_to_site_id INT;
ALTER TABLE sales_orders ADD CONSTRAINT IF NOT EXISTS fk_so_ship_to_site
    FOREIGN KEY (ship_to_site_id) REFERENCES customer_ship_to_sites(site_id);

-- Alternative path: project → cost allocation → department (vs project → resources → employees → dept)
CREATE TABLE IF NOT EXISTS project_cost_allocations (
    allocation_id SERIAL PRIMARY KEY,
    project_id INT REFERENCES projects(project_id),
    department_id INT REFERENCES departments(department_id),
    cost_center_id INT REFERENCES cost_centers(cost_center_id),
    allocation_pct NUMERIC(5,2) NOT NULL,
    fiscal_year INT NOT NULL,
    amount NUMERIC(12,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_proj_cost_alloc_project ON project_cost_allocations(project_id);
CREATE INDEX IF NOT EXISTS idx_proj_cost_alloc_dept ON project_cost_allocations(department_id);

-- ============================================
-- Archetype-specific tables
-- ============================================

{% if archetype == "manufacturing" %}
-- ============================================
-- Manufacturing archetype tables
-- ============================================

{% if dirty_naming %}
-- Dirty naming variant (abbreviated columns)

CREATE TABLE IF NOT EXISTS xx_mfg_bom (
    bom_id SERIAL PRIMARY KEY,
    prod_nbr INT REFERENCES products(product_id),
    parent_bom_id INT,
    comp_prod_nbr INT REFERENCES products(product_id),
    qty_per NUMERIC(10,4) NOT NULL,
    uom_cd VARCHAR(10),
    eff_strt_dt DATE DEFAULT CURRENT_DATE,
    eff_end_dt DATE,
    sts_cd VARCHAR(20) DEFAULT 'AC',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_xx_mfg_bom_prod ON xx_mfg_bom(prod_nbr);

CREATE TABLE IF NOT EXISTS xx_mfg_bom_rev (
    rev_id SERIAL PRIMARY KEY,
    bom_id INT REFERENCES xx_mfg_bom(bom_id),
    rev_nbr VARCHAR(20) NOT NULL,
    rev_dt DATE NOT NULL,
    chg_desc_txt TEXT,
    aprvl_sts_cd VARCHAR(20) DEFAULT 'SB',
    approved_by INT REFERENCES employees(employee_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS xx_mfg_wo (
    wo_id SERIAL PRIMARY KEY,
    wo_nbr VARCHAR(30) NOT NULL,
    prod_nbr INT REFERENCES products(product_id),
    qty_ordered NUMERIC(12,2) NOT NULL,
    qty_completed NUMERIC(12,2) DEFAULT 0,
    strt_dt DATE,
    end_dt DATE,
    sts_cd VARCHAR(20) DEFAULT 'DR',
    priority_cd VARCHAR(20) DEFAULT 'MD',
    wh_id INT REFERENCES warehouses(warehouse_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_xx_mfg_wo_prod ON xx_mfg_wo(prod_nbr);

CREATE TABLE IF NOT EXISTS xx_mfg_wo_ops (
    op_id SERIAL PRIMARY KEY,
    wo_id INT REFERENCES xx_mfg_wo(wo_id),
    op_seq INT NOT NULL,
    wc_id INT,
    op_desc_txt TEXT,
    setup_hrs NUMERIC(8,2),
    run_hrs NUMERIC(8,2),
    sts_cd VARCHAR(20) DEFAULT 'DR',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS xx_mfg_wc (
    wc_id SERIAL PRIMARY KEY,
    wc_cd VARCHAR(20) NOT NULL,
    wc_desc_txt TEXT,
    dept_nbr INT REFERENCES departments(department_id),
    cap_per_hr NUMERIC(10,2),
    cost_per_hr NUMERIC(10,2),
    is_active BOOLEAN DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS xx_mfg_qhold (
    hold_id SERIAL PRIMARY KEY,
    wo_id INT REFERENCES xx_mfg_wo(wo_id),
    hold_rsn_txt TEXT NOT NULL,
    hold_dt TIMESTAMPTZ DEFAULT NOW(),
    rlse_dt TIMESTAMPTZ,
    held_by INT REFERENCES employees(employee_id),
    sts_cd VARCHAR(20) DEFAULT 'AC',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS xx_mfg_scrap (
    scrap_id SERIAL PRIMARY KEY,
    wo_id INT REFERENCES xx_mfg_wo(wo_id),
    prod_nbr INT REFERENCES products(product_id),
    scrap_qty NUMERIC(12,2) NOT NULL,
    rsn_cd VARCHAR(20),
    scrap_dt DATE NOT NULL,
    rpt_by INT REFERENCES employees(employee_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS xx_mfg_routing (
    routing_id SERIAL PRIMARY KEY,
    prod_nbr INT REFERENCES products(product_id),
    routing_cd VARCHAR(20) NOT NULL,
    rev_nbr VARCHAR(10),
    eff_strt_dt DATE DEFAULT CURRENT_DATE,
    eff_end_dt DATE,
    is_active BOOLEAN DEFAULT TRUE
);

{% else %}
-- Clean naming variant

CREATE TABLE IF NOT EXISTS mfg_bill_of_materials (
    bom_id SERIAL PRIMARY KEY,
    product_id INT REFERENCES products(product_id),
    parent_bom_id INT,
    component_product_id INT REFERENCES products(product_id),
    quantity_per NUMERIC(10,4) NOT NULL,
    unit_of_measure VARCHAR(10),
    effective_start_date DATE DEFAULT CURRENT_DATE,
    effective_end_date DATE,
    status_code VARCHAR(20) DEFAULT 'AC',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_mfg_bom_product ON mfg_bill_of_materials(product_id);

CREATE TABLE IF NOT EXISTS mfg_bom_revisions (
    revision_id SERIAL PRIMARY KEY,
    bom_id INT REFERENCES mfg_bill_of_materials(bom_id),
    revision_number VARCHAR(20) NOT NULL,
    revision_date DATE NOT NULL,
    change_description TEXT,
    approval_status_code VARCHAR(20) DEFAULT 'SB',
    approved_by INT REFERENCES employees(employee_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS mfg_work_orders (
    work_order_id SERIAL PRIMARY KEY,
    work_order_number VARCHAR(30) NOT NULL,
    product_id INT REFERENCES products(product_id),
    quantity_ordered NUMERIC(12,2) NOT NULL,
    quantity_completed NUMERIC(12,2) DEFAULT 0,
    start_date DATE,
    end_date DATE,
    status_code VARCHAR(20) DEFAULT 'DR',
    priority_code VARCHAR(20) DEFAULT 'MD',
    warehouse_id INT REFERENCES warehouses(warehouse_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_mfg_wo_product ON mfg_work_orders(product_id);

CREATE TABLE IF NOT EXISTS mfg_wo_operations (
    operation_id SERIAL PRIMARY KEY,
    work_order_id INT REFERENCES mfg_work_orders(work_order_id),
    operation_sequence INT NOT NULL,
    work_center_id INT,
    operation_description TEXT,
    setup_hours NUMERIC(8,2),
    run_hours NUMERIC(8,2),
    status_code VARCHAR(20) DEFAULT 'DR',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS mfg_work_centers (
    work_center_id SERIAL PRIMARY KEY,
    work_center_code VARCHAR(20) NOT NULL,
    description TEXT,
    department_id INT REFERENCES departments(department_id),
    capacity_per_hour NUMERIC(10,2),
    cost_per_hour NUMERIC(10,2),
    is_active BOOLEAN DEFAULT TRUE
);

CREATE TABLE IF NOT EXISTS mfg_quality_holds (
    hold_id SERIAL PRIMARY KEY,
    work_order_id INT REFERENCES mfg_work_orders(work_order_id),
    hold_reason TEXT NOT NULL,
    hold_date TIMESTAMPTZ DEFAULT NOW(),
    release_date TIMESTAMPTZ,
    held_by INT REFERENCES employees(employee_id),
    status_code VARCHAR(20) DEFAULT 'AC',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS mfg_scrap_log (
    scrap_id SERIAL PRIMARY KEY,
    work_order_id INT REFERENCES mfg_work_orders(work_order_id),
    product_id INT REFERENCES products(product_id),
    scrap_quantity NUMERIC(12,2) NOT NULL,
    reason_code VARCHAR(20),
    scrap_date DATE NOT NULL,
    reported_by INT REFERENCES employees(employee_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS mfg_routing_master (
    routing_id SERIAL PRIMARY KEY,
    product_id INT REFERENCES products(product_id),
    routing_code VARCHAR(20) NOT NULL,
    revision_number VARCHAR(10),
    effective_start_date DATE DEFAULT CURRENT_DATE,
    effective_end_date DATE,
    is_active BOOLEAN DEFAULT TRUE
);

{% endif %}
{% endif %}

{% if archetype == "services" %}
-- ============================================
-- Services archetype tables
-- ============================================

{% if dirty_naming %}
-- Dirty naming variant

CREATE TABLE IF NOT EXISTS zz_svc_sow (
    sow_id SERIAL PRIMARY KEY,
    proj_nbr INT REFERENCES projects(project_id),
    cust_nbr INT REFERENCES customers(customer_id),
    sow_nbr VARCHAR(30) NOT NULL,
    desc_txt TEXT,
    tot_amt NUMERIC(12,2),
    strt_dt DATE,
    end_dt DATE,
    sts_cd VARCHAR(20) DEFAULT 'DR',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_zz_svc_sow_proj ON zz_svc_sow(proj_nbr);

CREATE TABLE IF NOT EXISTS zz_svc_dlvr (
    dlvr_id SERIAL PRIMARY KEY,
    sow_id INT REFERENCES zz_svc_sow(sow_id),
    dlvr_nbr INT NOT NULL,
    desc_txt TEXT NOT NULL,
    due_dt DATE,
    sts_cd VARCHAR(20) DEFAULT 'PL',
    aprvl_sts_cd VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS zz_svc_rsrc_plan (
    plan_id SERIAL PRIMARY KEY,
    sow_id INT REFERENCES zz_svc_sow(sow_id),
    emp_nbr INT REFERENCES employees(employee_id),
    role_txt VARCHAR(50),
    alloc_pct NUMERIC(5,2),
    strt_dt DATE,
    end_dt DATE,
    rate_amt NUMERIC(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS zz_svc_bill_ms (
    milestone_id SERIAL PRIMARY KEY,
    sow_id INT REFERENCES zz_svc_sow(sow_id),
    ms_nbr INT NOT NULL,
    desc_txt TEXT,
    amt NUMERIC(12,2) NOT NULL,
    due_dt DATE,
    inv_dt DATE,
    sts_cd VARCHAR(20) DEFAULT 'PL',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS zz_svc_skill (
    skill_id SERIAL PRIMARY KEY,
    emp_nbr INT REFERENCES employees(employee_id),
    skill_nm VARCHAR(100) NOT NULL,
    lvl_cd VARCHAR(20),
    cert_dt DATE,
    exp_dt DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS zz_svc_engage_log (
    log_id SERIAL PRIMARY KEY,
    sow_id INT REFERENCES zz_svc_sow(sow_id),
    log_dt TIMESTAMPTZ DEFAULT NOW(),
    log_type_cd VARCHAR(20),
    desc_txt TEXT,
    logged_by INT REFERENCES employees(employee_id)
);

CREATE TABLE IF NOT EXISTS zz_svc_rate_cd (
    rate_id SERIAL PRIMARY KEY,
    role_txt VARCHAR(50) NOT NULL,
    lvl_cd VARCHAR(20),
    rate_amt NUMERIC(10,2) NOT NULL,
    currency_cd VARCHAR(3) DEFAULT 'USD',
    eff_strt_dt DATE DEFAULT CURRENT_DATE,
    eff_end_dt DATE,
    is_active BOOLEAN DEFAULT TRUE
);

{% else %}
-- Clean naming variant

CREATE TABLE IF NOT EXISTS svc_statements_of_work (
    sow_id SERIAL PRIMARY KEY,
    project_id INT REFERENCES projects(project_id),
    customer_id INT REFERENCES customers(customer_id),
    sow_number VARCHAR(30) NOT NULL,
    description TEXT,
    total_amount NUMERIC(12,2),
    start_date DATE,
    end_date DATE,
    status_code VARCHAR(20) DEFAULT 'DR',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_svc_sow_project ON svc_statements_of_work(project_id);

CREATE TABLE IF NOT EXISTS svc_deliverables (
    deliverable_id SERIAL PRIMARY KEY,
    sow_id INT REFERENCES svc_statements_of_work(sow_id),
    deliverable_number INT NOT NULL,
    description TEXT NOT NULL,
    due_date DATE,
    status_code VARCHAR(20) DEFAULT 'PL',
    approval_status_code VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS svc_resource_plan (
    plan_id SERIAL PRIMARY KEY,
    sow_id INT REFERENCES svc_statements_of_work(sow_id),
    employee_id INT REFERENCES employees(employee_id),
    role_name VARCHAR(50),
    allocation_percent NUMERIC(5,2),
    start_date DATE,
    end_date DATE,
    rate_amount NUMERIC(10,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS svc_billing_milestones (
    milestone_id SERIAL PRIMARY KEY,
    sow_id INT REFERENCES svc_statements_of_work(sow_id),
    milestone_number INT NOT NULL,
    description TEXT,
    amount NUMERIC(12,2) NOT NULL,
    due_date DATE,
    invoice_date DATE,
    status_code VARCHAR(20) DEFAULT 'PL',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS svc_skill_matrix (
    skill_id SERIAL PRIMARY KEY,
    employee_id INT REFERENCES employees(employee_id),
    skill_name VARCHAR(100) NOT NULL,
    proficiency_level VARCHAR(20),
    certification_date DATE,
    expiration_date DATE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS svc_engagement_log (
    log_id SERIAL PRIMARY KEY,
    sow_id INT REFERENCES svc_statements_of_work(sow_id),
    log_date TIMESTAMPTZ DEFAULT NOW(),
    log_type VARCHAR(20),
    description TEXT,
    logged_by INT REFERENCES employees(employee_id)
);

CREATE TABLE IF NOT EXISTS svc_rate_cards (
    rate_id SERIAL PRIMARY KEY,
    role_name VARCHAR(50) NOT NULL,
    proficiency_level VARCHAR(20),
    rate_amount NUMERIC(10,2) NOT NULL,
    currency_code VARCHAR(3) DEFAULT 'USD',
    effective_start_date DATE DEFAULT CURRENT_DATE,
    effective_end_date DATE,
    is_active BOOLEAN DEFAULT TRUE
);

{% endif %}
{% endif %}

{% if archetype == "retail" %}
-- ============================================
-- Retail archetype tables
-- ============================================

{% if dirty_naming %}
-- Dirty naming variant

CREATE TABLE IF NOT EXISTS zz_pos_trnx (
    trnx_id SERIAL PRIMARY KEY,
    store_nbr INT,
    register_nbr INT,
    cust_nbr INT REFERENCES customers(customer_id),
    emp_nbr INT REFERENCES employees(employee_id),
    trnx_dt TIMESTAMPTZ NOT NULL,
    tot_amt NUMERIC(12,2) NOT NULL,
    tax_amt NUMERIC(12,2) DEFAULT 0,
    pay_mthd_cd VARCHAR(20),
    sts_cd VARCHAR(20) DEFAULT 'CP',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_zz_pos_trnx_cust ON zz_pos_trnx(cust_nbr);

CREATE TABLE IF NOT EXISTS zz_pos_ln (
    ln_id SERIAL PRIMARY KEY,
    trnx_id INT REFERENCES zz_pos_trnx(trnx_id),
    prod_nbr INT REFERENCES products(product_id),
    qty NUMERIC(10,2) NOT NULL,
    unit_prc NUMERIC(10,2) NOT NULL,
    disc_amt NUMERIC(10,2) DEFAULT 0,
    ln_tot NUMERIC(12,2) NOT NULL,
    promo_cd VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS zz_loy_mbr (
    mbr_id SERIAL PRIMARY KEY,
    cust_nbr INT REFERENCES customers(customer_id),
    mbr_nbr VARCHAR(30) NOT NULL,
    enroll_dt DATE NOT NULL,
    tier_cd VARCHAR(20) DEFAULT 'BZ',
    pts_bal INT DEFAULT 0,
    sts_cd VARCHAR(20) DEFAULT 'AC',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_zz_loy_mbr_cust ON zz_loy_mbr(cust_nbr);

CREATE TABLE IF NOT EXISTS zz_loy_txn (
    txn_id SERIAL PRIMARY KEY,
    mbr_id INT REFERENCES zz_loy_mbr(mbr_id),
    trnx_id INT REFERENCES zz_pos_trnx(trnx_id),
    pts_earned INT,
    pts_redeemed INT,
    txn_dt TIMESTAMPTZ DEFAULT NOW(),
    txn_type_cd VARCHAR(20)
);

CREATE TABLE IF NOT EXISTS zz_rtl_promo (
    promo_id SERIAL PRIMARY KEY,
    promo_cd VARCHAR(20) NOT NULL,
    promo_nm VARCHAR(100) NOT NULL,
    desc_txt TEXT,
    strt_dt DATE NOT NULL,
    end_dt DATE NOT NULL,
    disc_type_cd VARCHAR(20),
    disc_val NUMERIC(10,2),
    sts_cd VARCHAR(20) DEFAULT 'AC',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS zz_rtl_promo_prod (
    promo_prod_id SERIAL PRIMARY KEY,
    promo_id INT REFERENCES zz_rtl_promo(promo_id),
    prod_nbr INT REFERENCES products(product_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS zz_rtl_store_inv (
    store_inv_id SERIAL PRIMARY KEY,
    store_nbr INT,
    prod_nbr INT REFERENCES products(product_id),
    qty_on_hand NUMERIC(12,2) NOT NULL,
    qty_reserved NUMERIC(12,2) DEFAULT 0,
    last_count_dt DATE,
    reorder_pt NUMERIC(12,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

{% else %}
-- Clean naming variant

CREATE TABLE IF NOT EXISTS rtl_pos_transactions (
    transaction_id SERIAL PRIMARY KEY,
    store_number INT,
    register_number INT,
    customer_id INT REFERENCES customers(customer_id),
    employee_id INT REFERENCES employees(employee_id),
    transaction_date TIMESTAMPTZ NOT NULL,
    total_amount NUMERIC(12,2) NOT NULL,
    tax_amount NUMERIC(12,2) DEFAULT 0,
    payment_method_code VARCHAR(20),
    status_code VARCHAR(20) DEFAULT 'CP',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_rtl_pos_cust ON rtl_pos_transactions(customer_id);

CREATE TABLE IF NOT EXISTS rtl_pos_line_items (
    line_id SERIAL PRIMARY KEY,
    transaction_id INT REFERENCES rtl_pos_transactions(transaction_id),
    product_id INT REFERENCES products(product_id),
    quantity NUMERIC(10,2) NOT NULL,
    unit_price NUMERIC(10,2) NOT NULL,
    discount_amount NUMERIC(10,2) DEFAULT 0,
    line_total NUMERIC(12,2) NOT NULL,
    promotion_code VARCHAR(20),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS rtl_loyalty_members (
    member_id SERIAL PRIMARY KEY,
    customer_id INT REFERENCES customers(customer_id),
    member_number VARCHAR(30) NOT NULL,
    enrollment_date DATE NOT NULL,
    tier_code VARCHAR(20) DEFAULT 'BZ',
    points_balance INT DEFAULT 0,
    status_code VARCHAR(20) DEFAULT 'AC',
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_rtl_loyalty_cust ON rtl_loyalty_members(customer_id);

CREATE TABLE IF NOT EXISTS rtl_loyalty_txns (
    txn_id SERIAL PRIMARY KEY,
    member_id INT REFERENCES rtl_loyalty_members(member_id),
    transaction_id INT REFERENCES rtl_pos_transactions(transaction_id),
    points_earned INT,
    points_redeemed INT,
    txn_date TIMESTAMPTZ DEFAULT NOW(),
    txn_type_code VARCHAR(20)
);

CREATE TABLE IF NOT EXISTS rtl_promotions (
    promotion_id SERIAL PRIMARY KEY,
    promotion_code VARCHAR(20) NOT NULL,
    promotion_name VARCHAR(100) NOT NULL,
    description TEXT,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    discount_type_code VARCHAR(20),
    discount_value NUMERIC(10,2),
    status_code VARCHAR(20) DEFAULT 'AC',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS rtl_promo_products (
    promo_product_id SERIAL PRIMARY KEY,
    promotion_id INT REFERENCES rtl_promotions(promotion_id),
    product_id INT REFERENCES products(product_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS rtl_store_inventory (
    store_inv_id SERIAL PRIMARY KEY,
    store_number INT,
    product_id INT REFERENCES products(product_id),
    quantity_on_hand NUMERIC(12,2) NOT NULL,
    quantity_reserved NUMERIC(12,2) DEFAULT 0,
    last_count_date DATE,
    reorder_point NUMERIC(12,2),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

{% endif %}
{% endif %}

{% if archetype == "corporate" %}
-- ============================================
-- Corporate archetype tables
-- ============================================

CREATE TABLE IF NOT EXISTS corp_intercompany_txns (
    ic_txn_id SERIAL PRIMARY KEY,
    from_division VARCHAR(10) NOT NULL,
    to_division VARCHAR(10) NOT NULL,
    transaction_date DATE NOT NULL,
    amount NUMERIC(14,2) NOT NULL,
    currency_code VARCHAR(3) DEFAULT 'USD',
    description TEXT,
    status_code VARCHAR(20) DEFAULT 'PD',
    account_id INT REFERENCES chart_of_accounts(account_id),
    created_by INT REFERENCES employees(employee_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE INDEX IF NOT EXISTS idx_corp_ic_txn_date ON corp_intercompany_txns(transaction_date);

CREATE TABLE IF NOT EXISTS corp_consolidation_entries (
    consolidation_id SERIAL PRIMARY KEY,
    fiscal_period_id INT REFERENCES fiscal_periods(period_id),
    source_division VARCHAR(10) NOT NULL,
    account_id INT REFERENCES chart_of_accounts(account_id),
    original_amount NUMERIC(14,2) NOT NULL,
    translated_amount NUMERIC(14,2),
    currency_code VARCHAR(3),
    exchange_rate NUMERIC(12,6),
    status_code VARCHAR(20) DEFAULT 'DR',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS corp_elimination_entries (
    elimination_id SERIAL PRIMARY KEY,
    consolidation_id INT REFERENCES corp_consolidation_entries(consolidation_id),
    debit_account_id INT REFERENCES chart_of_accounts(account_id),
    credit_account_id INT REFERENCES chart_of_accounts(account_id),
    amount NUMERIC(14,2) NOT NULL,
    elimination_type VARCHAR(30),
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS corp_statutory_reports (
    report_id SERIAL PRIMARY KEY,
    report_name VARCHAR(100) NOT NULL,
    report_type VARCHAR(30) NOT NULL,
    fiscal_period_id INT REFERENCES fiscal_periods(period_id),
    jurisdiction VARCHAR(50),
    due_date DATE,
    filed_date DATE,
    status_code VARCHAR(20) DEFAULT 'DR',
    prepared_by INT REFERENCES employees(employee_id),
    approved_by INT REFERENCES employees(employee_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS corp_tax_provisions (
    provision_id SERIAL PRIMARY KEY,
    fiscal_period_id INT REFERENCES fiscal_periods(period_id),
    jurisdiction VARCHAR(50) NOT NULL,
    tax_type VARCHAR(30) NOT NULL,
    current_provision NUMERIC(14,2),
    deferred_provision NUMERIC(14,2),
    effective_rate NUMERIC(8,4),
    statutory_rate NUMERIC(8,4),
    status_code VARCHAR(20) DEFAULT 'DR',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS corp_audit_findings (
    finding_id SERIAL PRIMARY KEY,
    audit_type VARCHAR(30) NOT NULL,
    finding_date DATE NOT NULL,
    severity VARCHAR(20) NOT NULL,
    department_id INT REFERENCES departments(department_id),
    description TEXT NOT NULL,
    remediation_plan TEXT,
    due_date DATE,
    status_code VARCHAR(20) DEFAULT 'OP',
    assigned_to INT REFERENCES employees(employee_id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS corp_compliance_checklists (
    checklist_id SERIAL PRIMARY KEY,
    regulation_name VARCHAR(100) NOT NULL,
    requirement TEXT NOT NULL,
    department_id INT REFERENCES departments(department_id),
    responsible_employee_id INT REFERENCES employees(employee_id),
    review_date DATE,
    next_review_date DATE,
    status_code VARCHAR(20) DEFAULT 'PD',
    evidence_reference TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

{% endif %}

RESET search_path;
